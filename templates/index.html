<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻影显形 - WPS 自动打卡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .card p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* 扫码区域 */
        .qrcode-section {
            text-align: center;
        }

        .qrcode-wrapper {
            display: inline-block;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 15px 0;
        }

        .qrcode-wrapper img {
            width: 180px;
            height: 180px;
            border-radius: 8px;
        }

        .qrcode-placeholder {
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e9ecef;
            border-radius: 8px;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .status-text {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }

        .status-text.success { color: #28a745; }
        .status-text.error { color: #dc3545; }

        /* 按钮 */
        .btn {
            display: inline-block;
            padding: 10px 25px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-block { width: 100%; display: block; }

        /* 表单 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: #6c757d;
            font-size: 12px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* 打卡记录 */
        .log-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .log-item .status {
            width: 60px;
            font-weight: 600;
        }

        .log-item .status.success { color: #28a745; }
        .log-item .status.failed { color: #dc3545; }

        .log-item .message {
            flex: 1;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .log-item .time {
            color: #999;
            font-size: 12px;
        }

        /* 用户信息 */
        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }

        .user-info .name {
            font-weight: 600;
            color: #333;
        }

        .user-info .wps-uid {
            color: #999;
            font-size: 12px;
        }

        /* 隐藏/显示 */
        .hidden { display: none !important; }

        /* 链接 */
        .admin-link {
            text-align: center;
            margin-top: 20px;
        }

        .admin-link a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 13px;
        }

        .admin-link a:hover {
            color: white;
        }

        /* 时间显示 */
        .time-display {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .schedule-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .schedule-info .label {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }

        /* 响应式 */
        @media (max-width: 500px) {
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 未登录：扫码登录 -->
        <div id="login-section" class="card qrcode-section">
            <h2>扫码登录 WPS</h2>
            <p>使用微信扫描二维码，授权登录 WPS 账号</p>

            <div class="qrcode-wrapper">
                <div id="qrcode-container">
                    <div class="qrcode-placeholder">点击下方按钮<br>获取二维码</div>
                </div>
            </div>

            <p id="status-text" class="status-text"></p>

            <button id="get-qrcode-btn" class="btn btn-primary" onclick="startLogin()">
                获取登录二维码
            </button>
        </div>

        <!-- 已登录：用户面板 -->
        <div id="user-panel" class="hidden">
            <!-- 用户信息 -->
            <div class="card">
                <div class="user-info">
                    <div>
                        <div class="name" id="user-nickname">用户</div>
                        <div class="wps-uid">WPS ID: <span id="user-wps-uid"></span></div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="logout()">退出登录</button>
                </div>

                <div class="schedule-info">
                    <div class="label">打卡时间</div>
                    <div class="time-display" id="checkin-time">--:--</div>
                    <div class="label" style="margin-top:5px;">上次打卡: <span id="last-checkin">从未</span></div>
                </div>

                <button class="btn btn-success btn-block" onclick="manualCheckin()">立即打卡</button>
            </div>

            <!-- 个人设置 -->
            <div class="card">
                <h2>个人设置</h2>

                <div class="form-group">
                    <label>打卡填写内容</label>
                    <input type="text" id="input_name" placeholder="例如：1000&张三&">
                    <small>填写在打卡表单中显示的内容</small>
                </div>

                <div class="form-group">
                    <label>昵称</label>
                    <input type="text" id="nickname" placeholder="用于显示">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>纬度</label>
                        <input type="number" id="latitude" step="0.0000001">
                    </div>
                    <div class="form-group">
                        <label>经度</label>
                        <input type="number" id="longitude" step="0.0000001">
                    </div>
                </div>

                <div class="form-group">
                    <label>自定义打卡时间（可选）</label>
                    <div class="form-row">
                        <select id="checkin_hour">
                            <option value="">使用系统时间</option>
                            <script>
                                for (let i = 0; i < 24; i++) {
                                    document.write(`<option value="${i}">${i.toString().padStart(2, '0')}时</option>`);
                                }
                            </script>
                        </select>
                        <select id="checkin_minute">
                            <option value="">--</option>
                            <script>
                                for (let i = 0; i < 60; i += 5) {
                                    document.write(`<option value="${i}">${i.toString().padStart(2, '0')}分</option>`);
                                }
                            </script>
                        </select>
                    </div>
                    <small>留空则使用系统默认打卡时间</small>
                </div>

                <div class="form-group">
                    <label>Server酱 SendKey（打卡通知）</label>
                    <input type="text" id="sendkey" placeholder="SCTxxxxxx">
                    <small>
                        用于接收打卡结果通知，获取地址：
                        <a href="https://sct.ftqq.com/sendkey" target="_blank">sct.ftqq.com/sendkey</a>
                    </small>
                </div>

                <button class="btn btn-primary btn-block" onclick="saveConfig()">保存设置</button>
            </div>

            <!-- 打卡记录 -->
            <div class="card">
                <h2>打卡记录</h2>
                <div id="log-list">
                    <p style="color: #999; text-align: center;">暂无记录</p>
                </div>
            </div>
        </div>

        <!-- 管理员入口 -->
        <div class="admin-link">
            <a href="/admin">管理员入口</a>
        </div>
    </div>

    <script>
        // ==================== 全局变量 ====================
        let currentUser = null;
        let currentChannelId = null;
        let pollInterval = null;

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await checkLogin();
        });

        async function checkLogin() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();

                if (data.logged_in) {
                    currentUser = data.user;
                    showUserPanel();
                } else {
                    showLoginSection();
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                showLoginSection();
            }
        }

        function showLoginSection() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('user-panel').classList.add('hidden');
        }

        function showUserPanel() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('user-panel').classList.remove('hidden');

            // 填充用户信息
            document.getElementById('user-nickname').textContent = currentUser.nickname || '用户' + currentUser.wps_uid;
            document.getElementById('user-wps-uid').textContent = currentUser.wps_uid;
            document.getElementById('last-checkin').textContent = currentUser.last_checkin || '从未';

            // 打卡时间
            if (currentUser.checkin_hour !== null && currentUser.checkin_minute !== null) {
                document.getElementById('checkin-time').textContent =
                    `${String(currentUser.checkin_hour).padStart(2,'0')}:${String(currentUser.checkin_minute).padStart(2,'0')} (自定义)`;
            } else {
                loadSystemSchedule();
            }

            // 填充表单
            document.getElementById('input_name').value = currentUser.input_name || '';
            document.getElementById('nickname').value = currentUser.nickname || '';
            document.getElementById('latitude').value = currentUser.latitude || 100;
            document.getElementById('longitude').value = currentUser.longitude || 100;
            document.getElementById('sendkey').value = currentUser.sendkey || '';

            if (currentUser.checkin_hour !== null) {
                document.getElementById('checkin_hour').value = currentUser.checkin_hour;
            }
            if (currentUser.checkin_minute !== null) {
                document.getElementById('checkin_minute').value = currentUser.checkin_minute;
            }

            // 加载打卡记录
            loadLogs();
        }

        async function loadSystemSchedule() {
            try {
                const response = await fetch('/api/schedules');
                const schedules = await response.json();
                const enabled = schedules.filter(s => s.is_enabled);
                if (enabled.length > 0) {
                    document.getElementById('checkin-time').textContent = enabled[0].time_str + ' (系统)';
                }
            } catch (error) {
                console.error('加载系统时间失败:', error);
            }
        }

        // ==================== 登录流程 ====================
        async function startLogin() {
            const btn = document.getElementById('get-qrcode-btn');
            const statusText = document.getElementById('status-text');
            const qrcodeContainer = document.getElementById('qrcode-container');

            btn.disabled = true;
            btn.textContent = '获取中...';
            statusText.textContent = '';
            statusText.className = 'status-text';

            try {
                const response = await fetch('/api/login/start', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    currentChannelId = data.channel_id;
                    qrcodeContainer.innerHTML = `<img src="${data.qrcode_url}" alt="登录二维码">`;
                    statusText.textContent = '请使用微信扫描二维码';
                    btn.textContent = '刷新二维码';
                    btn.disabled = false;
                    startPolling();
                } else {
                    throw new Error(data.detail || '获取二维码失败');
                }
            } catch (error) {
                statusText.textContent = '获取二维码失败: ' + error.message;
                statusText.className = 'status-text error';
                btn.textContent = '重新获取';
                btn.disabled = false;
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                if (!currentChannelId) return;

                try {
                    const response = await fetch(`/api/login/status/${currentChannelId}`);
                    const data = await response.json();
                    const statusText = document.getElementById('status-text');

                    switch (data.status) {
                        case 'waiting':
                            statusText.textContent = '等待扫码...';
                            break;
                        case 'scanning':
                            statusText.textContent = '已扫码，正在登录...';
                            break;
                        case 'success':
                            statusText.textContent = '登录成功！';
                            statusText.className = 'status-text success';
                            clearInterval(pollInterval);
                            pollInterval = null;
                            currentChannelId = null;
                            // 重新检查登录状态
                            await checkLogin();
                            break;
                        case 'failed':
                            statusText.textContent = '登录失败: ' + (data.error || '未知错误');
                            statusText.className = 'status-text error';
                            clearInterval(pollInterval);
                            pollInterval = null;
                            currentChannelId = null;
                            break;
                    }
                } catch (error) {
                    console.error('轮询出错:', error);
                }
            }, 2000);
        }

        // ==================== 用户操作 ====================
        async function saveConfig() {
            const config = {
                input_name: document.getElementById('input_name').value,
                nickname: document.getElementById('nickname').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                sendkey: document.getElementById('sendkey').value
            };

            // 打卡时间
            const hour = document.getElementById('checkin_hour').value;
            const minute = document.getElementById('checkin_minute').value;
            if (hour !== '' && minute !== '') {
                config.checkin_hour = parseInt(hour);
                config.checkin_minute = parseInt(minute);
            } else {
                config.checkin_hour = null;
                config.checkin_minute = null;
            }

            try {
                const response = await fetch('/api/me', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    alert('设置保存成功！');
                    await checkLogin();
                } else {
                    const data = await response.json();
                    throw new Error(data.detail || '保存失败');
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        async function manualCheckin() {
            if (!confirm('确定要立即执行打卡吗？')) return;

            try {
                const response = await fetch('/api/me/checkin', { method: 'POST' });
                if (response.ok) {
                    alert('打卡任务已提交，请稍后查看记录');
                    setTimeout(loadLogs, 3000);
                } else {
                    const data = await response.json();
                    throw new Error(data.detail || '打卡失败');
                }
            } catch (error) {
                alert('打卡失败: ' + error.message);
            }
        }

        async function loadLogs() {
            const container = document.getElementById('log-list');

            try {
                const response = await fetch('/api/me/logs?limit=10');
                const logs = await response.json();

                if (logs.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center;">暂无记录</p>';
                    return;
                }

                container.innerHTML = logs.map(log => `
                    <div class="log-item">
                        <span class="status ${log.status}">${log.status === 'success' ? '成功' : '失败'}</span>
                        <span class="message">${log.message || '-'}</span>
                        <span class="time">${log.created_at}</span>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<p style="color: #dc3545; text-align: center;">加载失败</p>`;
            }
        }

        async function logout() {
            try {
                await fetch('/api/me/logout', { method: 'POST' });
                currentUser = null;
                showLoginSection();
                // 重置扫码界面
                document.getElementById('qrcode-container').innerHTML =
                    '<div class="qrcode-placeholder">点击下方按钮<br>获取二维码</div>';
                document.getElementById('status-text').textContent = '';
            } catch (error) {
                console.error('登出失败:', error);
            }
        }
    </script>
</body>
</html>
